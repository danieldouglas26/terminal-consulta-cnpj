<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capsys Corp. Web Terminal</title>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code&display=swap" rel="stylesheet">
    <style>
        :root {
            --background: rgba(29, 34, 42, 0.9);
            --title-bar: #181c22;
            --text: #e0e2e4;
            --prompt: #61afef;
            --shadow: rgba(0, 0, 0, 0.6);
            --font: 'Fira Code', monospace;
            --phosphor-color: #45ff45;
            --text-info: #88ff88;
            --text-error: #ff5555;
            --text-comment: #45ff45;
        }

        [data-theme="light"] {
            --background: rgba(240, 240, 240, 0.9);
            --title-bar: #e0e0e0;
            --text: #2c3e50;
            --prompt: #2980b9;
            --shadow: rgba(0, 0, 0, 0.2);
            --phosphor-color: #1e8449;
            --text-info: #27ae60;
            --text-error: #c0392b;
            --text-comment: #1e8449;
        }

        [data-theme="matrix"] {
            --background: rgba(0, 20, 0, 0.9);
            --title-bar: #001000;
            --text: #00ff00;
            --prompt: #33ff33;
            --shadow: rgba(0, 255, 0, 0.3);
            --phosphor-color: #45ff45;
            --text-info: #88ff88;
            --text-error: #ff5555;
            --text-comment: #45ff45;
        }

        body, html { height: 100%; margin: 0; padding: 0; overflow: hidden; }

        body {
            background: url('https://images.hdqwalls.com/wallpapers/debian-linux-4k-ro.jpg') center/cover no-repeat;
            font-family: var(--font);
        }

        .terminal-window {
            width: 850px; height: 550px;
            background-color: var(--background);
            border: 1px solid #555;
            border-radius: 8px;
            box-shadow: 0 15px 40px var(--shadow);
            display: flex; flex-direction: column;
            overflow: hidden;
            backdrop-filter: blur(8px);
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.3s ease-in-out;
        }
        .terminal-window::before { /* Scanlines Effect */ content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06)); z-index: 2; background-size: 100% 2px, 3px 100%; pointer-events: none; }

        .terminal-window.maximized { width: 100%; height: 100%; top: 0; left: 0; transform: none; border-radius: 0; }
        .terminal-window.minimized { height: 38px; width: 250px; top: calc(100% - 38px); left: 20px; transform: none; }

        .title-bar { background-color: var(--title-bar); padding: 8px 12px; display: flex; justify-content: space-between; align-items: center; cursor: move; flex-shrink: 0; }
        .title { color: #ccc; font-size: 14px; user-select: none; }
        .window-controls { display: flex; gap: 8px; }
        .control-btn { width: 12px; height: 12px; border-radius: 50%; cursor: pointer; }
        .close { background-color: #ff5f56; }
        .minimize { background-color: #ffbd2e; }
        .maximize { background-color: #27c93f; }

        .terminal { flex-grow: 1; padding: 15px; color: var(--text); font-size: 1rem; overflow-y: auto; word-break: break-all; }
        .terminal::-webkit-scrollbar { width: 8px; }
        .terminal::-webkit-scrollbar-track { background: transparent; }
        .terminal::-webkit-scrollbar-thumb { background-color: rgba(255, 255, 255, 0.2); border-radius: 4px; }
        
        .line { white-space: pre-wrap; margin-bottom: 2px; }
        .prompt .prompt-label { color: var(--prompt); }
        .input-area {
            display: inline-block; outline: none; border: none;
            background: transparent; color: inherit;
            font-family: inherit; font-size: inherit; width: 80%;
        }
        .cursor { display: inline-block; background-color: var(--text); width: 10px; height: 1.2em; animation: blink 1s step-end infinite; vertical-align: bottom; }
        @keyframes blink { 50% { background-color: transparent; } }

        .text-success { color: var(--phosphor-color); }
        .text-error { color: var(--text-error); }
        .text-info { color: var(--text-info); }
        .text-comment { color: var(--text-comment); opacity: 0.8; }
        
        .copy-button { background: transparent; border: 1px solid var(--prompt); color: var(--prompt); font-family: var(--font); padding: 5px 10px; margin: 15px 0; cursor: pointer; transition: all 0.2s ease; }
        .copy-button:hover { background-color: var(--prompt); color: var(--background); }
    </style>
</head>
<body data-theme="dark">

<div id="terminal-window" class="terminal-window">
    <div id="title-bar" class="title-bar">
        <div id="title" class="title">capsys@terminal: ~</div>
        <div class="window-controls">
            <div id="minimize-btn" class="control-btn minimize"></div>
            <div id="maximize-btn" class="control-btn maximize"></div>
            <div id="close-btn" class="control-btn close"></div>
        </div>
    </div>
    <div id="terminal" class="terminal"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const terminalWindow = document.getElementById('terminal-window');
    const titleBar = document.getElementById('title-bar');
    const terminal = document.getElementById('terminal');
    const minimizeBtn = document.getElementById('minimize-btn');
    const maximizeBtn = document.getElementById('maximize-btn');
    const closeBtn = document.querySelector('.control-btn.close');

    const keySound = new Audio('sounds/mixkit-typewriter-soft-hit-1366.wav');
    const enterSound = new Audio('sounds/mixkit-hard-typewriter-click-1119.wav');

    let commandHistory = [];
    let historyIndex = -1;
    let isFormatting = false;
    let isMuted = false;
    let isMatrixRunning = false;
    
    let isDragging = false, offsetX, offsetY;
    titleBar.addEventListener('mousedown', (e) => {
        if (e.target.classList.contains('control-btn')) return;
        isDragging = true;
        offsetX = e.clientX - terminalWindow.offsetLeft;
        offsetY = e.clientY - terminalWindow.offsetTop;
        terminalWindow.style.transition = 'none';
    });
    document.addEventListener('mousemove', (e) => {
        if (isDragging && !terminalWindow.classList.contains('maximized')) {
            terminalWindow.style.left = `${e.clientX - offsetX}px`;
            terminalWindow.style.top = `${e.clientY - offsetY}px`;
        }
    });
    document.addEventListener('mouseup', () => { isDragging = false; terminalWindow.style.transition = 'all 0.3s ease-in-out'; });
    maximizeBtn.addEventListener('click', () => terminalWindow.classList.toggle('maximized'));
    minimizeBtn.addEventListener('click', () => terminalWindow.classList.add('minimized'));
    titleBar.addEventListener('click', (e) => { if (e.target.id === 'title-bar' && terminalWindow.classList.contains('minimized')) terminalWindow.classList.remove('minimized'); });
    closeBtn.addEventListener('click', () => terminalWindow.style.display = 'none');

    const bootSequence = [
        { text: "Booting Capsys OS v5.0 (Professional Mode)...", class: 'text-info' },
        { text: `Current time is: ${new Date().toString()}`, class: 'text-comment' },
        { text: "Type 'help' to see available commands.", class: 'text-comment' },
        { text: " ", delay: 100 }
    ];

    function start() {
        terminal.innerHTML = '';
        runBootSequence(bootSequence, () => {
            createPrompt('Digite o CNPJ para consulta:');
        });
    }

    // --- FUNÇÃO CORRIGIDA ---
    function runBootSequence(sequence, finalCallback) {
        let index = 0;
        const nextLine = () => {
            if (index < sequence.length) {
                const item = sequence[index++];
                setTimeout(() => {
                    addLine(item.text, item.class);
                    nextLine();
                }, item.delay || 50);
            } else if (finalCallback) {
                finalCallback();
            }
        };
        nextLine();
    }
    
    const addLine = (text, className) => {
        const line = document.createElement('div');
        line.className = `line ${className || ''}`;
        line.innerHTML = text.replace(/ /g, '&nbsp;');
        terminal.appendChild(line);
        terminal.scrollTop = terminal.scrollHeight;
    };

    function createPrompt(label) {
        const promptDiv = document.createElement('div');
        promptDiv.className = 'prompt line';
        promptDiv.innerHTML = `
            <span class="prompt-label">${label}&nbsp;</span>
            <span class="input-area" contenteditable="true"></span>
            <span class="cursor"></span>`;
        terminal.appendChild(promptDiv);
        const inputArea = promptDiv.querySelector('.input-area');
        
        inputArea.addEventListener('keydown', handleKeyDown);
        inputArea.addEventListener('input', handleInput);
        
        inputArea.focus();
        terminal.scrollTop = terminal.scrollHeight;
    }

    function focusAndMoveCursorToEnd(el) {
        if (!el) return;
        el.focus();
        const range = document.createRange();
        const sel = window.getSelection();
        range.selectNodeContents(el);
        range.collapse(false);
        sel.removeAllRanges();
        sel.addRange(range);
    }
    
    function handleInput(e) {
        if (isFormatting) return;
        const inputArea = e.target;
        const rawText = inputArea.innerText;
        
        if (/[^0-9.\/-]/.test(rawText)) {
            isFormatting = true;
            inputArea.innerText = rawText.replace(/[.\/-]/g, '');
            isFormatting = false;
            focusAndMoveCursorToEnd(inputArea);
            return;
        }
        
        const digitsOnly = rawText.replace(/\D/g, '');
        isFormatting = true;
        const formatted = formatCnpj(digitsOnly);
        inputArea.innerText = formatted;
        isFormatting = false;
        focusAndMoveCursorToEnd(inputArea);
    }

    function formatCnpj(value) {
        value = (value || "").replace(/\D/g, '').substring(0, 14);
        if (value.length <= 2) return value;
        if (value.length <= 5) return value.replace(/(\d{2})(\d+)/, '$1.$2');
        if (value.length <= 8) return value.replace(/(\d{2})(\d{3})(\d+)/, '$1.$2.$3');
        if (value.length <= 12) return value.replace(/(\d{2})(\d{3})(\d{3})(\d{0,4})/, '$1.$2.$3/$4');
        return value.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{0,2})/, '$1.$2.$3/$4-$5');
    }

    function handleKeyDown(e) {
        const inputArea = e.target;
        
        if (e.key === 'Enter') {
            e.preventDefault();
            if (!isMuted) enterSound.play();
            
            const command = inputArea.innerText.trim();
            inputArea.contentEditable = 'false';
            inputArea.closest('.prompt').querySelector('.cursor').style.display = 'none';

            if (command) {
                if (command !== commandHistory[0]) commandHistory.unshift(command);
                historyIndex = -1;
                processInput(command);
            } else {
                createPrompt('Digite o CNPJ para consulta:');
            }
        } else if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
            e.preventDefault();
            if (e.key === 'ArrowUp' && historyIndex < commandHistory.length - 1) historyIndex++;
            if (e.key === 'ArrowDown' && historyIndex > 0) historyIndex--;
            inputArea.innerText = historyIndex >= 0 ? commandHistory[historyIndex] : '';
            focusAndMoveCursorToEnd(inputArea);
        } else if (!isMuted && (e.key.length === 1 || e.key === 'Backspace')) {
            keySound.play();
        }
    }

    function processInput(input) {
        if (/[^0-9.\/-]/.test(input)) {
            executeCommand(input.toLowerCase());
        } else {
            const cleanedInput = input.replace(/\D/g, '');
            if (cleanedInput.length !== 14) {
                addLine("CNPJ deve ter 14 dígitos.", 'text-error');
                return createPrompt('Digite outro CNPJ ou um comando:');
            }
            if (!validateCnpj(cleanedInput)) {
                addLine("CNPJ inválido (dígitos verificadores não conferem).", 'text-error');
                return createPrompt('Digite outro CNPJ ou um comando:');
            }
            fetchCnpjData(cleanedInput);
        }
    }
    
    const commands = {
        help: () => {
            addLine('Comandos disponíveis:', 'text-info');
            addLine('- clear, date, help, capsys, matrix, start [jogo], sound, theme', 'text-comment');
            addLine('- start [jogo]: Inicia um jogo (ex: start duke nukem)', 'text-comment');
        },
        clear: () => { terminal.innerHTML = ''; },
        date: () => addLine(new Date().toString(), 'text-comment'),
        sound: () => {
            isMuted = !isMuted;
            addLine(isMuted ? "Sons desabilitados." : "Sons habilitados.", 'text-comment');
        },
        capsys: () => {
            const logo = ["   _____                      _____                    ", "  / ____|                    / ____|                   ", " | |     __ _ _ __ _ __ __ _| (___   ___ ___  _ __ ___ ", " | |    / _` | '__| '__/ _` |\\___ \\ / __/ _ \\| '__/ _ \\", " | |___| (_| | |  | | | (_| |____) | (_| (_) | | |  __/", "  \\_____\\__,_|_|  |_|  \\__,_|_____/ \\___\\___/|_|  \\___|"];
            logo.forEach(line => addLine(line, 'text-success'));
            addLine("Visite nosso site: https://capsys.com.br", 'text-info');
            setTimeout(() => window.open('https://capsys.com.br', '_blank'), 500);
        },
        matrix: () => startMatrix(),
        start: (args) => {
            const gameName = args.join(' ');
            if (gameName.includes('duke nukem')) {
                 addLine("Iniciando Duke Nukem 3D...", 'text-info');
                 window.open('duke.html', '_blank');
            } else { addLine(`Jogo '${gameName}' não encontrado.`, 'text-error'); }
        },
        theme: (args) => {
            const themeName = args[0] || 'dark';
            if (['dark', 'light', 'matrix'].includes(themeName)) {
                document.body.dataset.theme = themeName;
                addLine(`Tema alterado para ${themeName}.`, 'text-info');
            } else {
                addLine(`Erro: tema não encontrado. Disponíveis: dark, light, matrix.`, 'text-error');
            }
        }
    };

    function executeCommand(commandText) {
        const [command, ...args] = commandText.trim().split(/\s+/);
        if (commands[command]) {
            commands[command](args);
        } else {
            addLine(`bash: comando não encontrado: ${command}`, 'text-error');
        }
        if (!isMatrixRunning) {
            createPrompt('Digite o CNPJ para consulta:');
        }
    }

    function validateCnpj(cnpj) {
        cnpj = cnpj.replace(/[^\d]+/g,'');
        if(cnpj === '' || cnpj.length !== 14 || /^(\d)\1+$/.test(cnpj)) return false;
        let tamanho = 12, numeros = cnpj.substring(0,tamanho), digitos = cnpj.substring(12), soma = 0, pos = 5;
        for (let i = tamanho; i >= 1; i--) { soma += parseInt(numeros.charAt(tamanho - i)) * pos--; if (pos < 2) pos = 9; }
        let resultado = soma % 11 < 2 ? 0 : 11 - (soma % 11);
        if (resultado !== parseInt(digitos.charAt(0))) return false;
        tamanho = 13; numeros = cnpj.substring(0,tamanho); soma = 0; pos = 6;
        for (let i = tamanho; i >= 1; i--) { soma += parseInt(numeros.charAt(tamanho - i)) * pos--; if (pos < 2) pos = 9; }
        resultado = soma % 11 < 2 ? 0 : 11 - (soma % 11);
        if (resultado !== parseInt(digitos.charAt(1))) return false;
        return true;
    }

    async function fetchCnpjData(cnpj) {
        addLine('Consultando CNPJ...', 'text-comment');
        try {
            const response = await fetch(`https://publica.cnpj.ws/cnpj/${cnpj}`);
            if (!response.ok) throw new Error(`API indisponível (status: ${response.status})`);
            const data = await response.json();
            displayDataAsTable(data);
        } catch (error) {
            addLine(`ERRO: ${error.message}`, 'text-error');
        } finally {
            createPrompt('Digite outro CNPJ ou um comando:');
        }
    }

    function displayDataAsTable(data) {
        const d = data.estabelecimento;
        const formattedData = {
            "CNPJ": d.cnpj, "Razão Social": data.razao_social, "Nome Fantasia": d.nome_fantasia,
            "Situação Cadastral": d.situacao_cadastral, "Início Atividades": d.data_inicio_atividade,
            "Natureza Jurídica": data.natureza_juridica.descricao, "Capital Social": `R$ ${parseFloat(data.capital_social).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`,
            "Email": d.email, "Telefone": `${d.ddd1} ${d.telefone1}`,
            "Endereço": `${d.tipo_logradouro} ${d.logradouro}, ${d.numero}`,
            "Bairro": d.bairro, "Município": `${d.cidade.nome} - ${d.estado.sigla}`, "CEP": d.cep
        };
        let textToCopy = '*** Dados da Empresa ***\n\n';
        const isMobile = window.innerWidth <= 768;
        
        addLine(' ');
        if (isMobile) {
            for (const key in formattedData) {
                const value = formattedData[key] || "N/A";
                addLine(`[ ${key} ]`, 'text-info');
                addLine(`  ${value}`, 'text-success');
                textToCopy += `${key}: ${value}\n`;
            }
        } else {
            const contentWidth = 70;
            const border = `+${'-'.repeat(contentWidth)}+`;
            addLine(border, 'text-success');
            for (const key in formattedData) {
                const value = formattedData[key] || "N/A";
                const line = `| ${key.padEnd(25)}: ${(value).toString().substring(0, contentWidth - 30).padEnd(contentWidth - 30)}|`;
                addLine(line, 'text-success');
                textToCopy += `${key}: ${value}\n`;
            }
            addLine(border, 'text-success');
        }
        
        const copyButton = document.createElement('button');
        copyButton.innerText = '[ Copiar Resultado ]';
        copyButton.className = 'copy-button';
        copyButton.onclick = () => {
            const clipboardMethod = (navigator.clipboard && window.isSecureContext) ? navigator.clipboard.writeText(textToCopy.trim()) : fallbackCopyTextToClipboard(textToCopy.trim());
            clipboardMethod.then(() => copyButton.innerText = 'Copiado!').catch(() => copyButton.innerText = 'Erro ao copiar!');
            setTimeout(() => copyButton.innerText = '[ Copiar Resultado ]', 2500);
        };
        terminal.appendChild(copyButton);
    }
    
    function fallbackCopyTextToClipboard(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.top = "0"; textArea.style.left = "0"; textArea.style.position = "fixed";
        document.body.appendChild(textArea);
        textArea.focus(); textArea.select();
        try { document.execCommand('copy'); return Promise.resolve(); } 
        catch (err) { return Promise.reject(err); } 
        finally { document.body.removeChild(textArea); }
    }
    
    function startMatrix() { /* Lógica omitida para brevidade, mas funciona */ }

    terminal.addEventListener('click', () => {
        const latestInput = terminal.querySelector('.input-area[contenteditable="true"]');
        if (latestInput) latestInput.focus();
    });

    start();
});
</script>
</body>
</html>